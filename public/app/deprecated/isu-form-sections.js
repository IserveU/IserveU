/* Based off https://github.com/jessicaquynh/isu-form-sections
 * Appears to still be used for file uploads. Need to move that functionality
 * Out
 */

function formatHttp(){return{restrict:"A",require:"ngModel",link:function(e,t,n,i){function o(e){return e&&!/^(https?):\/\//i.test(e)&&-1==="http://".indexOf(e)?(i.$setViewValue("http://"+e),i.$render(),"http://"+e):e}i.$formatters.push(o),i.$parsers.splice(0,0,o)}}}function textSection(e){"use strict";var t=e.startSymbol(),n=e.endSymbol();return{replace:!0,template:['<section style="order:'+t+"sections[$sIndex].order"+n+'" id="object-'+t+"sections[$sIndex].order"+n+'" ','sectionable section-id="sections[$sIndex].id || null" save-message="saveMessage">',"<md-toolbar>","<header>Text Section</header>",'<i class="display__save-messsage">'+t+"saveMessage"+n+"</i>",'<a class="mdi button mdi-chevron-up" ng-click="create.move(sections[$sIndex].order, false)" move-section></a>','<a class="mdi button mdi-chevron-down" ng-click="create.move(sections[$sIndex].order, true)" move-section></a>','<a class="mdi button mdi-close" ng-click="create.remove(sections[$sIndex].order)" delete-sectionable="text"></a>',"</md-toolbar>","<fieldset>",'<text-angular ng-model="sections[$sIndex].content.text"></text-angular>',"</fieldset>","</section>"].join("")}}function inlineImageSection(e){"use strict";var t=e.startSymbol(),n=e.endSymbol();return{replace:!0,controller:["$scope",function(e){e.imageFields=[0],e.addImage=function(t){var n=e.imageFields.length+1;e.imageFields.push(n)},e.removeImage=function(t,n){e.$parent.sections[e.$sIndex].content=e.$parent.sections[e.$sIndex].content.map(function(i){return i.file_id===t?void e.imageFields.splice(n,1):i}).filter(function(e){return!angular.isUndefined(e)})}}],link:function(e,t,n){var i=null,o=e.$watch(function(){if(e.$parent.sections[e.$sIndex]&&e.$parent.sections[e.$sIndex].content&&i!==e.$parent.sections[e.$sIndex].content.length){i=e.$parent.sections[e.$sIndex].content.length;for(var t=1;i>t;t++)e.imageFields.push(t);o()}})},template:['<section style="order:'+t+"sections[$sIndex].order"+n+'" id="object-'+t+"sections[$sIndex].order"+n+'"','sectionable section-id="sections[$sIndex].id || null" save-message="saveMessage">',"<md-toolbar>","<header>Inline Image Section</header>",'<i class="display__save-messsage">'+t+"saveMessage"+n+"</i>",'<a class="mdi button mdi-chevron-up" ng-click="create.move(sections[$sIndex].order, false)" move-section></a>','<a class="mdi button mdi-chevron-down" ng-click="create.move(sections[$sIndex].order, true)" move-section></a>','<a class="mdi button mdi-close" ng-click="create.remove(sections[$sIndex].order)" delete-sectionable="inlineimage"></a>',"</md-toolbar>",'<fieldset ng-repeat="(rIndex, r) in imageFields">','<span ng-if="sections[$sIndex].content[rIndex].file_id">','<a class="mdi button mdi-close" ng-click="removeImage(sections[$sIndex].content[rIndex].file_id, rIndex)"></a>','<img ng-src="/storage/app/'+t+"sections[$sIndex].content[rIndex].image.filename"+n+'"/>',"</span>",'<input class="md-button" type="file" name="sections['+t+"$sIndex"+n+"].content["+t+"rIndex"+n+'].image.file" ng-model="sections[$sIndex].content[rIndex].image.file" file="sections[$sIndex].content[rIndex].image.file"/>',"<md-input-container>","<label>Description</label>",'<input type="text" ng-model="sections[$sIndex].content[rIndex].image.description"/>',"</md-input-container>","<md-input-container>","<label>URL</label>",'<input type="url" ng-model="sections[$sIndex].content[rIndex].url" format-http/>',"</md-input-container>","</fieldset>",'<a class="mdi button mdi-plus" ng-click="addImage()"></a>',"</section>"].join("")}}function profileSection(e){"use strict";var t=e.startSymbol(),n=e.endSymbol();return{replace:!0,link:function(e,t,n){e.$watch(function(){if("undefined"!=typeof e.$parent.sections[e.$sIndex]){var t=e.$parent.sections[e.$sIndex].content;t&&t.hasOwnProperty("image")&&t.hasOwnProperty("heading")&&(t.image.description=t.heading+(t.subheading?" - "+t.subheading:""))}},!0)},template:['<section style="order:'+t+"sections[$sIndex].order"+n+'" id="object-'+t+"sections[$sIndex].order"+n+'"','sectionable section-id="sections[$sIndex].id || null" save-message="saveMessage">',"<md-toolbar>","<header>Profile Section</header>",'<i class="display__save-messsage">'+t+"saveMessage"+n+"</i>",'<a class="mdi button mdi-chevron-up" ng-click="create.move(sections[$sIndex].order, false)" move-section></a>','<a class="mdi button mdi-chevron-down" ng-click="create.move(sections[$sIndex].order, true)" move-section></a>','<a class="mdi button mdi-close" ng-click="create.remove(sections[$sIndex].order)" delete-sectionable="profile"></a>',"</md-toolbar>","<fieldset>",'<span ng-if="sections[$sIndex].content.file_id">','<img ng-src="/storage/app/'+t+"sections[$sIndex].image.filename"+n+'"/>',"</span>",'<input class="md-button" type="file" name="sections['+t+"$sIndex"+n+'].content.image.file" ng-model="sections[$sIndex].content.image.file" 	file="sections[$sIndex].content.image.file"/>','<span ng-if="(sections[$sIndex].content.image || sections[$sIndex].content.file_id)">',"<md-input-container>","<label>Heading</label>",'<input type="text" ng-model="sections[$sIndex].content.heading"/>',"</md-input-container>","<md-input-container>","<label>Subheading</label>",'<input type="text" ng-model="sections[$sIndex].content.subheading"/>',"</md-input-container>",'<text-angular ng-model="sections[$sIndex].content.text"></text-angular>',"</span>",'<input type="hidden" ng-model="sections[$sIndex].content.image.description"/>',"</fieldset>","</section>"].join("")}}angular.module("isu-form-sections",["isu.provider","isu.form-init","isu.create-section","isu.sections","isu.templates","isu.sectionable"]),angular.module("isu.provider",[]).provider("isuSectionProvider",function(){"use strict";this.defaults={serverFramework:"laravel",useDefaultTemplate:!0,method:"POST",target:"/",autopost:!0,fileEndpoint:"/justTheFile/",templateDefaults:null,types:null,possibleTypes:[{type:"Text",html:"<text-section></text-section>",url:"/section/tpl/textSection.tpl.html",schemaIsArray:!1,schema:{text:null}},{type:"InlineImage",html:"<inline-image-section></inline-image-section>",url:"/section/tpl/inlinePhotoSection.tpl.html",schemaIsArray:!0,schema:{image:{file:null,description:null,user_id:null},file_id:null,url:null}},{type:"Profile",html:"<profile-section></profile-section>",url:"/section/tpl/ProfileSection.tpl.html",schemaIsArray:!1,schema:{text:"Describe this person ..."}}]},this.$get=["$http","$q",function(e,t){return{defaults:this.defaults,possibleTypes:function(){return this.defaults.types||this.defaults.possibleTypes.map(function(e){return e.type})},getContentOf:function(e){var t=void 0;return this.defaults.possibleTypes.forEach(function(n){n.type===e&&(t=n.schemaIsArray?[n.schema]:n.schema)}),t},transformToFormData:function(e){function t(e,n,i){angular.forEach(n,function(n,o){if("object"==typeof n){if("string"==typeof o&&"$"===o.charAt(0))return;var r=i+"["+o+"]";n instanceof File?e.append(r,n):(Array.isArray(o)||"object"==typeof o||"number"==typeof o||"string"==typeof o&&"$"!==o.charAt(0))&&t(e,n,r)}else angular.isUndefined(n)||e.append(i+"["+o+"]",n)})}var n=new FormData;return angular.forEach(e,function(e,i){null===e||""===e||angular.isUndefined(e)||"$"===i.charAt(0)||("object"==typeof e&&0!==Object.keys(e).length?t(n,e,i):"$"!==i.charAt(0)&&"string"==typeof e||"number"==typeof e?n.append(i,e):e instanceof File&&n.append(i,e))}),n},callMethodToApi:function(n){var i=t.defer(),o=this.transformToFormData(n);return"laravel"===this.defaults.serverFramework&&"PATCH"===this.defaults.method&&(o.append("_method","PATCH"),this.defaults.method="POST"),e({method:this.defaults.method,url:this.defaults.target,data:o||{},transformRequest:angular.identity,headers:{"Content-Type":void 0}}).then(function(e){i.resolve(e)},function(e){console.log(e),i.reject(e)}),i.promise},setFileEndpoint:function(e,t){this.defaults.fileEndpoint=e+"/"+t+"/file"}}}]}),angular.module("isu.create-section",["isu.sections","isu.provider"]).directive("isuCreateSection",["$rootScope","$compile","$interpolate","$timeout","Section","isuSectionProvider",function(e,t,n,i,o,r){"use strict";function s(e){function t(t,i){if(0>=t&&!i||t+1===n()&&i)return!1;var o=i?1:-1;return e.sections.map(function(e){return e.order==t?e.order=t+o:e.order==t+o&&(e.order=t),e})}function n(){return 0===e.sections.length?0:Math.max.apply(Math,e.sections.map(function(e){return e.order+1}))}function s(t){return angular.isUndefined(t)?!1:(e.sections=e.sections.map(function(n){if(n.order===t){if(e.$emit("removeByOrder",{section:n}),!n.id)return;n._method="DELETE"}return n}).filter(function(e){return!angular.isUndefined(e)}),void a(e.sections))}function a(e){for(var t=e.sort(function(e,t){return e.order>t.order}),n=0,i=0;n<t.length;n++)t[n].hasOwnProperty("_method")&&"DELETE"===t[n]._method?t[n].order=999+n:t[n].order=i++;return e=t}function c(e){for(var t=0;t<e.length;t++)e[t].$getChildScope()&&(e[t].$getChildScope().$sIndex=t);return e}function l(t){angular.forEach(t,function(t,n){t.hasOwnProperty("images")&&null!==t.images&&(t.content=t.content.map(function(e){for(var n=0;n<t.images.length;n++)t.images[n].file_id==e.file_id&&(e.image=[],e.image.filename=t.images[n].file.filename,e.image.description=t.images[n].file.description);return e})),i(function(){e.$emit("compileSectionToView",{section:o.build(t)})},80)})}e.typeArray=r.possibleTypes(),e.sections=[],e.files=[],this.move=t,this.nextOrderance=n,this.remove=s,this.flattenOrder=a,this.updateScopeIndex=c,this.persistExisting=l}function a(n,i,r,s){n.$watchCollection(function(){return n.sections},function(e){var t=[];if(angular.isArray(e))t=e;else for(var n in e)hasOwnProperty.call(e,n)&&"$"!==n.charAt(0)&&t.push(n);s.flattenOrder(t),s.updateScopeIndex(t)}),n.$watch("create.type",function(t){t&&!angular.isUndefined(t)&&(s.type=null,e.$emit("compileSectionToView",{section:new o(t,s.nextOrderance())}))},!0),n.$on("removeByOrder",function(e,t){e.preventDefault(),t.section.$getChildScope().$destroy(),angular.element(document.getElementById("object-"+t.section.order)).remove(),s.updateScopeIndex(n.sections)}),e.$on("compileSectionToView",function(e,o){if(e.preventDefault(),!o.hasOwnProperty("section"))throw new Error("No section data was provided to compile into DOM.");var r,s,a,c;r=o.section,s=r.$getTemplate(),r.$setChildScope(n.$new()),n.sections.push(r),a=t(s),c=a(r.$getChildScope()),i.append(c)})}return{restrict:"AE",transclude:!0,scope:{sections:"=isuBindSection"},template:["<div ng-transclude></div>",'<md-select ng-model="create.type" placeholder="Add new section">','<md-option ng-value="null">Add new Section</md-option>','<md-option ng-value="type" ng-repeat="type in typeArray">'+n.startSymbol()," type "+n.endSymbol()+" Section</md-option>","</md-select>"].join(""),controllerAs:"create",controller:["$scope",s],link:a}}]),angular.module("isu.create-section").directive("isuEditSection",function(){return{restrict:"A",require:"^isuCreateSection",link:function(e,t,n,i){var o=angular.extend({},e.$eval(n.isuEditSection)),r=JSON.parse(angular.toJson(o));i.persistExisting(r)}}}),angular.module("isu.file-upload",["isu.provider"]).factory("isuFileUploadService",["isuSectionProvider",function(e){function t(e){return o(e,"POST")}function n(e){return o(e,"PATCH")}function i(e,t,n){return $http.get(e+"/"+t+"/file/"+n).then(function(e){return e},function(e){return e})}function o(t,n){var i=r(t),o=s(t);angular.extend(e.defaults,{target:i,method:n});var a={file:t.file,title:o};return e.callMethodToApi(a).then(function(e){return e},function(e){return e})}function r(e){return e.target+"/"+e.parent_id+"/"+(e.type||"file")+"/"+(e.slug||null)}function s(e){return e.type+" for "+e.target+"_id: "+e.parent_id}return{uploadFile:t,updateFile:n,getFile:i}}]).directive("isuFileUploader",["isuSectionProvider",function(e){function t(e,t,n,i){t.bind("change",function(t){t.preventDefault();angular.extend({},e.$eval(n.isuFileUploader))})}return{restrict:"AE",scope:{},link:t}}]),angular.module("isu-form-sections").directive("formatHttp",formatHttp),angular.module("isu.form-init",["isu.provider"]).directive("isuSectionInit",["isuSectionProvider",function(e){return{restrict:"A",controller:function(){function e(e,t,i){for(var o=i,r=n(e),s=r.length,a=0;s-1>a;a++){var c=r[a];o[c]||(o[c]={}),o=o[c]}o[r[s-1]]=t}function t(e,t){return n(e)[0]===n(t)[0]}function n(e){return e=e.replace(/\[(.*?)\]/g,".$1"),e=e.replace(/^\./,""),e.split(".")}this.setObject=e,this.matchAttr=t},link:{pre:function(t,n,i){var o=angular.extend([],t.$eval(i.isuSectionTypes));e.defaults.types=o},post:function(t,n,i,o){n.on("submit",function(n){var o=angular.extend({},t.$eval(i.isuSectionInit)),r=angular.extend({},t.$eval(i.isuSectionObject));return o.hasOwnProperty("autopost")&&!o.autopost?!1:(angular.extend(e.defaults,o||{}),void e.callMethodToApi(r).then(function(e){t.$success=e,t.$eval(i.isuSectionSuccess)},function(e){t.$error=e,t.$eval(i.isuSectionError)}))}),n.bind("change",function(e){if(e.preventDefault(),e.target.files){var n=e.target.files[0],r=e.target.getAttribute("ng-model"),s=e.target.name;o.setObject(o.matchAttr(s,r)?i.isuSectionObject+"."+s:r,n,t),t.$apply()}})}}}}]),angular.module("isu.sectionable",["isu.provider"]).service("debouncer",["$timeout",function(e){this.Debounce=function(){var t;return this.Invoke=function(n,i,o){var r=this,s=arguments,a=function(){t=null,o||n.apply(r,s)},c=o&&!t;t&&e.cancel(t),t=e(a,i),c&&n.apply(r,s)},this}}]).directive("sectionable",["isuSectionProvider","debouncer","$timeout",function(e,t,n){return{restrict:"A",scope:{sectionId:"=",saveMessage:"="},controller:["$scope",function(e){function i(t){e.$emit("destroySectionFromView",{contentType:t})}function o(){n(function(){e.$emit("saveAllSections",{})},1e3)}new t.Debounce;this.destroy=i,this.move=o}],link:function(n,i,o,r){function s(){for(var e in n.$parent.$parent.sections){var t=n.$parent.$parent.sections[e];if(t.$$childScope.$sIndex==n.$parent.$sIndex)return t}}function a(){return n.$parent.$parent.sections}function c(){n.saveMessage="Unable to save"}function l(e){n.saveMessage="Saved"}var u=window.location.pathname;u=u.substr(0,u.length-4);var d=new t.Debounce;n.saveMessage="",i.bind("keydown keyup",function(t){var i=function(){var t=s(),i=t.type.toLowerCase(),o=u.concat(i+"section/"+n.sectionId);angular.extend(e.defaults,{target:o,method:"PATCH"}),e.callMethodToApi(t).then(function(e){l(e.updated_at)},function(e){throw c(),new Error("Unable to update this "+i+" section")})},o=function(){var t=s(),n=t.type.toLowerCase(),i=u.concat(n+"section");angular.extend(e.defaults,{target:i,method:"POST"}),e.callMethodToApi(t).then(function(e){t.id=e.id,l(e.updated_at)},function(e){throw c(),new Error("Unable to create a "+n+" section")})},r=function(){n.saveMessage="Saving ...";var e=s();return n.sectionId?i(e):o(e)};d.Invoke(function(){n.$apply(r)},1e3,!1)}),n.$on("destroySectionFromView",function(t,i){if(t.preventDefault(),n.sectionId){var o=i.contentType.toLowerCase(),r=u.concat(o+"section/"+n.sectionId);angular.extend(e.defaults,{target:r,method:"DELETE"}),e.callMethodToApi().then(function(e){},function(e){throw c(),new Error("Unable to delete this "+o+" section")})}}),n.$on("saveAllSections",function(t,n){t.preventDefault();var i=a();for(var o in i){if(i[o].hasOwnProperty("_method")&&"DELETE"==i[o]._method)return;var r=i[o].type.toLowerCase(),s=u.concat(r+"section/"+(i[o].id||"")),d=i[o].id?"PATCH":"POST";angular.extend(e.defaults,{target:s,method:d}),e.callMethodToApi(i[o]).then(function(e){l(e.updated_at)},function(e){throw c(),new Error("Unable to update this "+r+" section")})}})}}}]).directive("deleteSectionable",["isuSectionProvider",function(e){return{restrict:"A",require:"^sectionable",link:function(e,t,n,i){t.bind("click",function(e){e.preventDefault(),i.destroy(n.deleteSectionable)})}}}]).directive("moveSection",["isuSectionProvider",function(e){return{restrict:"A",require:"^sectionable",link:function(e,t,n,i){t.bind("click",function(e){e.preventDefault(),i.move()})}}}]),angular.module("isu-form-sections").directive("textSection",textSection).directive("inlineImageSection",inlineImageSection).directive("profileSection",profileSection),textSection.$inject=["$interpolate"],inlineImageSection.$inject=["$interpolate"],profileSection.$inject=["$interpolate"],angular.module("isu.sections",["isu.templates","isu.provider"]).factory("Section",["TemplateFactory","isuSectionProvider",function(e,t){"use strict";function n(e,t,n){this.type=e,this.order=t,this.content=n||null}function i(e){return-1!==r.indexOf(e)}function o(e,t){angular.forEach(t,function(t,n){e.hasOwnProperty(n)||(e[n]=t)})}n.prototype.$setChildScope=function(e){this.$$childScope=e},n.prototype.$getChildScope=function(){return this.$$childScope},n.prototype.$getTemplate=function(){var n=new e;return t.defaults.useDefaultTemplate?n.$getDefault(this.type):n.$getCustom(this.type)};var r=t.possibleTypes();return n.possibleTypes=angular.copy(r),n.build=function(e){if(i(e.type)){var r=new n(e.type,e.order,e.content||t.getContentOf(e.type));return o(r,e),r}},n}]),angular.module("isu.templates",["isu.provider"]).factory("TemplateFactory",["isuSectionProvider",function(e){"use strict";function t(){this.defaults=e.defaults.possibleTypes}return t.prototype.custom={},t.prototype.$getDefault=function(e){return this.defaults.filter(function(t){return t.type===e?t:void 0}).map(function(e){return e.html||t.retrieveHtml(e.url)})[0]},t.prototype.$setCustom=function(t){var n=e.possibleTypes();n.hasOwnProperty(t.type)||this.defaults.possibleTypes.push(t)},t.prototype.$getCustom=function(e){return this.custom.filter(function(t){return t.type===e?t:void 0}).map(function(e){return e.html||t.retrieveHtml(e.url)})[0]},t.retrieveHtml=function(e){return"<div>Function to retreive HTML</div>"},t.build=function(e){return new t(!e||angular.isUndefined(e)?defaults:e)},t}]);